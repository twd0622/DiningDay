<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="Review_Report">
	
	
	<insert id="insertReport" parameterType="map">
		insert into STORE_REPORT (SREP_NO, CUS_NO, STORE_NO, STORE_NAME, SREP_TITLE, SREP_FILE, SREP_CONTENT, SREP_DATE, SREP_PROCESS)
    	values(concat("SR", IFNULL((select MAX(cast(replace(SREP_NO, "SR", "") AS unsigned))+1 FROM STORE_REPORT A), 1)), #{cus_no}, #{store_no}, #{store_name}, #{srep_subject}, #{srep_file}, #{srep_content}, date_format(now(), '%Y%m%d%H%i%s'), '0');		    
	</insert>
	
	<insert id="insertReview" parameterType="map">
		insert into REVIEW(REV_NO, CUS_NO, CUS_NICK, STORE_NO, RES_NO, SEAT_NO, REV_CONTENT, REV_DATE, REV_SCORE, REV_GOOD, REV_IMAGE)
		values(
		concat("RV", IFNULL((select MAX(cast(replace(REV_NO, "RV", "") AS unsigned))+1 FROM REVIEW A), 1))
		, #{cus_no}
		, #{cus_nick}
		, (select STORE_NO from RESERVATION where RES_NO = #{res_no})
		, #{res_no}
		, (select SEAT_NO from RESERVATION where RES_NO = #{res_no})
		, #{rev_content}
		, date_format(now(), '%Y%m%d%H%i%s')
		, #{rev_score}
		, '0'
		, #{rev_image}); 
    			    
	</insert>	
	
	<select id="getNick" resultType="String" parameterType="String">
		select CUS_NICK
		from CUSTOMER
		WHERE CUS_NO = #{CUS_NO}
	</select>
	
	<select id="getStoreId" resultType="map" parameterType="String">
		  select
				  ST.STORE_NO
				, ST.STORE_NAME
				, ST.STORE_TEL
				, ST.STORE_CATEGORY
				, ST.STORE_DETAIL
				, (select count(LIKE_NO) LIKE_COUNT from LIKE_LIST where STORE_NO = ST.STORE_NO) LIKE_COUNT
		        , R.REVIEW_COUNT
		        , R.REV_SCORE
				, SI.BA1
				, SI.BA2
			 from STORE ST
			 LEFT JOIN (SELECT STORE_NO
							, MAX(CASE WHEN PHOTO_TYPE = 'BA1' THEN PHOTO_NAME END) AS BA1
							, MAX(CASE WHEN PHOTO_TYPE = 'BA2' THEN PHOTO_NAME END) AS BA2
						FROM STORE_IMAGE
						GROUP BY STORE_NO ) SI
		 	   ON ST.STORE_NO = SI.STORE_NO     
		     JOIN (select S.STORE_NO
					   	, count(R.REV_NO) REVIEW_COUNT
					  	, format(avg(R.REV_SCORE), 1) REV_SCORE
				  	 from STORE S
				 	 join REVIEW R
					   on S.STORE_NO = R.STORE_NO
				 	group by S.STORE_NO) R
			  ON ST.STORE_NO = R.STORE_NO
		   where ST.STORE_NO = #{STORE_NO};
	
	</select>
</mapper>



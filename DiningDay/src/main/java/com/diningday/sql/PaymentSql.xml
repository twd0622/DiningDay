<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="Payment">
	
	<select id="getCustomerInfo" parameterType="String" resultType="map">
		select
		       CUS_NO
		     , CUS_NAME  
		     , CUS_TEL
	         , CUS_EMAIL	
		  from CUSTOMER
		 where CUS_NO = #{CUS_NO};
	</select>
	
	<select id="getMenuInfo" parameterType="map" resultType="map">
		 select
			 MENU_NO
			 , STORE_NO
			 , MENU_NAME
			 , FORMAT(MENU_PRICE, 0) MENU_PRICE
			 , MENU_HIDE
			 , MENU_INFO
		 from MENU
 		where STORE_NO = #{store_no};
	</select>
	
	<select id="getStoreInfo" parameterType="map" resultType="map">
		 SELECT 
			 STORE_NO	
			, STORE_NAME	
			, STORE_TEL	
			, STORE_LOCATION
		FROM STORE
		WHERE STORE_NO = #{store_no};
	</select>
	
	
	<insert id="paymentInsert" parameterType="map">
		INSERT INTO PAYMENT
			( PAY_NO
			, RES_NO
			, CUS_NO
			, MERCHANT_UID
			, APPLY_NUM
			, BUYER_NAME
			, BUYER_EMAIL
			, BUYER_TEL
			, CARD_NAME
			, CARD_NUMBER
			, NAME
			, PAID_AMOUNT
			, PAID_AT
			)
		VALUES
			( concat("PA" ,ifnull((select cast(max(replace(PAY_NO, "PA", "")) as unsigned)+1 from PAYMENT a), 1))
			, concat("RS" ,ifnull((select cast(max(replace(RES_NO, "RS", "")) as unsigned)+1 from RESERVATION a), 1))
			, #{CUS_NO}
			, #{merchant_uid}
			, #{apply_num}
			, #{buyer_name}
			, #{buyer_email}
			, #{buyer_tel}
			, #{card_name}
			, #{card_number}
			, #{name}
			, #{paid_amount}
			, #{paid_at}
			);
			
		INSERT INTO RESERVATION
			( RES_NO
			, CUS_NO
			, STORE_NO
			, PAY_NO
			, SEAT_NO
			, CUS_NAME
			, CUS_TEL
			, RES_REQ
			, RES_PEOPLE
			, RES_DATE
			, RES_TIME
			, REQ_STATE
			, RES_PAYTIME
			)
		VALUES
			( concat("RS" ,(select cast(max(replace(RES_NO, "RS", "")) as unsigned)+1 from RESERVATION a))
			, #{CUS_NO}
			, #{STORE_NO}
			, concat("PA" ,(select cast(max(replace(PAY_NO, "PA", "")) as unsigned)+1 from PAYMENT a))
			, #{SEAT_NO}
			, ( SELECT CUS_NAME FROM CUSTOMER WHERE CUS_NO = #{CUS_NO})
			, ( SELECT CUS_TEL FROM CUSTOMER WHERE CUS_NO = #{CUS_NO})
			, #{RES_DATE}
			, #{RES_PEOPLE}
			, #{RES_REQ}
			, #{RES_TIME}
			, '0'
			, date_format(now(), '%Y%m%d%H%i%s')
			);				
		
	</insert>
	
</mapper>





